import{g as Le,z as Ce,r as c,v as Te,c as ue,h as ee,o as ke,b as te,d as se,a as he,E as C,x as Ee,A as $e,B as qe,w as He,e as t,t as z,F as ce,n as Xe,j as q,C as H,f as B,u as V,i as fe,y as Ye,l as X,q as Oe,s as Ge,_ as Je}from"./index-Dkd1HQJ2.js";import{b as Ke,f as Y,m as pe,c as me,d as ge,e as Qe,g as O,r as D,M as ve,u as Ze,i as et}from"./initMap-DFYsgEnA.js";import{p as tt,a as st,b as it,c as at}from"./wind_back-DRSxZdC_.js";import{u as rt,a as N,s as nt,i as ot,v as K,b as F,r as j,c as W,d as lt,e as dt,f as ut,P as ye,N as Q,g as Z,D as ht}from"./axios-C2RRHLEQ.js";import{S as ct,f as ft,t as pt,c as xe}from"./controller-DBhFXwJS.js";import{g as mt,a as we,i as gt,d as Pe,b as be,c as Se,e as vt,f as yt,h as xt,u as wt,j as _e,k as Pt,l as Be}from"./api-DykwizrF.js";import"./stationInfo-DixEZJLI.js";class bt{constructor(s,o,m,g){this.type="custom",this.map=void 0,this.id=s,this.renderingMode="3d",this.preheat=0,this.swapPointer=0,this.extent=Ke(),this.worker=void 0,this.uvUrlList=m,this.stationUrl=o,this.endPoint="",this.progress=0,this.startPoint="",this.framesPerPhase=100,this.maxSpeed=Y(),this.maxParticleNum=1e4,this.progressRate=Y(),this.currentResourcePointer=0,this.particleNum=rt(3e3),this.speedFactor=Y(1),this.timePointParser=g,this.randomSeed=Y(Math.random()),this.blockSizeX=16,this.blockSizeY=16,this.lastMvp=pe(),this.lastMvpInverse=pe(),this.groupSizeX=Math.ceil(Math.sqrt(this.maxParticleNum)/this.blockSizeX),this.groupSizeY=Math.ceil(Math.sqrt(this.maxParticleNum)/this.blockSizeY),this.randomFillData=new Float32Array(this.maxParticleNum*6).map((v,r)=>r%6==4||r%6==5?0:Math.random()),this.toRef=void 0,this.fromRef=void 0,this.nextRef=void 0,this.uniformBuffer_frame=void 0,this.indexBuffer_voronoi=void 0,this.vertexBuffer_voronoi=void 0,this.uniformBuffer_static=void 0,this.storageBuffer_particle=void 0,this.particleRef=N(this.randomFillData),this.flowTexture=void 0,this.depthTexture=void 0,this.layerTexture1=void 0,this.layerTexture2=void 0,this.copiedDepthTexture=void 0,this.showBinding=void 0,this.layerBindings=void 0,this.voronoiBinding=void 0,this.segmentBinding=void 0,this.voronoiToBinding=void 0,this.simulationBinding=void 0,this.trajectoryBindings=void 0,this.showPipeline=void 0,this.layerPipeline=void 0,this.voronoiPipeline=void 0,this.segmentPipeline=void 0,this.trajectoryPipeline=void 0,this.simulationPipeline=void 0,this.swapPasses=void 0,this.voronoiPass=void 0,this.simulationPass=void 0,this.isHided=!1,this.isIdling=!1,this.showArrow=!1,this.showVoronoi=!0,this.nextPrepared=!1,this.isInitialized=!1,this.nextPreparing=!1}onAdd(s,o){this.map=s,this.map.on("movestart",()=>this.idle()),this.map.on("move",()=>this.idle()),this.map.on("moveend",()=>this.restart()),this.map.on("dragstart",()=>this.idle()),this.map.on("drag",()=>this.idle()),this.map.on("dragend",()=>this.restart()),this.map.on("zoomstart",()=>this.idle()),this.map.on("zoom",()=>this.idle()),this.map.on("zoomend",()=>this.restart()),this.map.on("rotatestart",()=>this.idle()),this.map.on("rotate",()=>this.idle()),this.map.on("rotateend",()=>this.restart()),this.map.on("pitchstart",()=>this.idle()),this.map.on("pitch",()=>this.idle()),this.map.on("pitchend",()=>this.restart()),this.addWorker(new Worker(new URL("/assets/flowJson.worker-DpdRasT2.js",import.meta.url),{type:"module"})),this.init()}render(s,o){if(this.map.triggerRepaint(),!(!this.isInitialized||this.isIdling||this.preheat-- >0)){if(this.isHided){this.makeVisibility(!1);return}else this.makeVisibility(!0);this.showBinding.executable=!1,this.swapPasses[0].executable=this.swapPasses[1].executable=this.layerBindings[0].executable=this.swapPointer,this.swapPasses[2].executable=this.swapPasses[3].executable=this.layerBindings[1].executable=1-this.swapPointer,this.swapPointer=(this.swapPointer+1)%2,this.updateVoronoi(),this.randomSeed.n=Math.random(),this.lastMvp.copyFrom(this.map.uMatrix),this.lastMvpInverse.copyFrom(this.map.mvpInverse)}}async resetResource(s){let o=async m=>{this.nextPreparing=!0;let g=await Z.get(m,{responseType:"arraybuffer"}),v=new Float32Array(g.data),r=-1/0;for(let n=0;n<v.length;n+=2){const a=v[n+0],d=v[n+1],P=Math.sqrt(a*a+d*d);r=P>r?P:r}this.nextRef.value=v,this.updateMaxSpeed(r),this.nextPreparing=!1,this.nextPrepared=!0,v=null,g=null};this.progress=0,this.maxSpeed.n=0,this.progressRate.n=0,this.uvUrlList=s,this.startPoint=this.timePointParser(this.uvUrlList[0]),this.endPoint=this.timePointParser(this.uvUrlList[this.uvUrlList.length-1]),await o(this.uvUrlList[0]),this.swapVoronoiBinding(),await o(this.uvUrlList[1]),this.swapVoronoiBinding(),this.currentResourcePointer=1,this.nextPrepared=!0}async setProgress(s){let o=Math.ceil(s/100*(this.uvUrlList.length-1)),m=o+1;m==this.uvUrlList.length&&(m=0);let g=async v=>{this.nextPreparing=!0;let r=await Z.get(v,{responseType:"arraybuffer"}),n=new Float32Array(r.data),a=-1/0;for(let d=0;d<n.length;d+=2){const P=n[d+0],b=n[d+1],i=Math.sqrt(P*P+b*b);a=i>a?i:a}this.nextRef.value=n,this.updateMaxSpeed(a),this.nextPreparing=!1,this.nextPrepared=!0,r=null,n=null};this.progress=0,this.maxSpeed.n=0,this.progressRate.n=0,this.startPoint=this.timePointParser(this.uvUrlList[0]),this.endPoint=this.timePointParser(this.uvUrlList[this.uvUrlList.length-1]),await g(this.uvUrlList[o]),this.swapVoronoiBinding(),await g(this.uvUrlList[m]),this.swapVoronoiBinding(),this.currentResourcePointer=m,this.nextPrepared=!0}async init(){this.isInitialized=!1;let s=async g=>{const v=await Z.get(g,{responseType:"arraybuffer"}),r=new ht(new Float32Array(v.data)),n=[],a=r.triangles;for(let d=0;d<r.points.length;d+=2){this.extent.update(r.points[d+0],r.points[d+1]);const P=Re(ve.mercatorXfromLon(r.points[d+0])),b=Re(ve.mercatorYfromLat(r.points[d+1]));n.push(P[0]),n.push(b[0]),n.push(P[1]),n.push(b[1])}return this.nextRef=N(new Float32Array(r.points.length).fill(0)),this.fromRef=N(new Float32Array(r.points.length).fill(0)),this.toRef=N(new Float32Array(r.points.length).fill(0)),{indices:a,vertices:n}};const{indices:o,vertices:m}=await s(this.stationUrl);await this.resetResource(this.uvUrlList),this.storageBuffer_particle=nt({name:"Storage Buffer (Particle Position & Velocity)",resource:{arrayRef:this.particleRef}}),this.uniformBuffer_static=me({name:"Uniform Buffer (Flow Layer Static)",blocks:[ge({name:"staticUniform",map:{groupSize:Qe(this.groupSizeX,this.groupSizeY),extent:this.extent.boundary}})]}),this.uniformBuffer_frame=me({name:"Uniform Buffer (Flow Layer Frame)",blocks:[ge({name:"frameUniform",dynamic:!0,map:{randomSeed:this.randomSeed,viewPort:this.map.screen.sizeF,mapBounds:this.map.cameraBounds.boundary,zoomLevel:this.map.zoom,progressRate:this.progressRate,maxSpeed:this.maxSpeed,lastMvp:this.lastMvp,lastMvpInverse:this.lastMvpInverse,fillWidth:O(1),aaWidth:O(2)}})]}),this.layerTexture1=this.map.screen.createScreenDependentTexture("Texture (Background 1)"),this.layerTexture2=this.map.screen.createScreenDependentTexture("Texture (Background 2)"),this.flowTexture=this.map.screen.createScreenDependentTexture("Texture (Velocity)","rg32float"),this.indexBuffer_voronoi=ot({name:"IndexBuffer (Voronoi Index)",resource:{arrayRef:N(new Uint32Array(o))}}),this.vertexBuffer_voronoi=K({name:"VertexBuffer (Station Position)",resource:{arrayRef:N(new Float32Array(m)),structure:[{components:4}]}}),this.voronoiBinding=F({name:"Binding (Flow-Field Voronoi)",range:()=>[this.indexBuffer_voronoi.length],index:{buffer:this.indexBuffer_voronoi},vertices:[{buffer:this.vertexBuffer_voronoi},{buffer:K({name:"VertexBuffer (Station Velocity (From))",resource:{arrayRef:this.fromRef,structure:[{components:2}]}})},{buffer:K({name:"VertexBuffer (Station Velocity (To))",resource:{arrayRef:this.toRef,structure:[{components:2}]}})}],sharedUniforms:[{buffer:this.uniformBuffer_frame},{buffer:this.uniformBuffer_static},{buffer:this.map.dynamicUniformBuffer}]}),this.voronoiPipeline=j({name:"Render Pipeline (Voronoi Flow)",shader:{module:W.load("Shader (Flow Voronoi)","/shaders/flowVoronoi.wgsl")}}),this.voronoiPass=D({name:"Render Pass (Voronoi Flow From)",colorAttachments:[{colorResource:this.flowTexture}],depthStencilAttachment:{depthStencilResource:this.map.depthTexture}}).add(this.voronoiPipeline,this.voronoiBinding),this.simulationBinding=F({name:"Binding (Particle Simulation)",range:()=>[this.groupSizeX,this.groupSizeY],textures:[{texture:this.flowTexture,sampleType:"unfilterable-float"}],storages:[{buffer:this.storageBuffer_particle,writable:!0}],uniforms:[{name:"controllerUniform",dynamic:!0,map:{particleNum:lt(this.maxParticleNum),dropRate:O(.003),dropRateBump:O(.001),speedFactor:this.speedFactor}}],sharedUniforms:[{buffer:this.uniformBuffer_frame},{buffer:this.uniformBuffer_static},{buffer:this.map.dynamicUniformBuffer}]}),this.simulationPipeline=dt({name:"Compute Pipeline (Flow Simulation)",shader:{module:W.load("Shader (Particle Simulation)","/shaders/simulation.compute.wgsl")},constants:{blockSize:16}}),this.simulationPass=ut({name:"Compute Pass (Particle Simulation)"}).add(this.simulationPipeline,this.simulationBinding),this.trajectoryBindings=[F({name:"Binding (Background Swap 1)",range:()=>[4],textures:[{texture:this.layerTexture2}],sharedUniforms:[{buffer:this.uniformBuffer_frame},{buffer:this.map.dynamicUniformBuffer}]}),F({name:"Binding (Background Swap 2)",range:()=>[4],textures:[{texture:this.layerTexture1}],sharedUniforms:[{buffer:this.uniformBuffer_frame},{buffer:this.map.dynamicUniformBuffer}]})],this.trajectoryPipeline=j({name:"Render pipeline (Background Trajectory)",shader:{module:W.load("Shader (Background Trajectory)","/shaders/trajectory.wgsl")},colorTargetStates:[{blend:ye}],primitive:{topology:"triangle-strip"},depthTest:!1}),this.segmentBinding=F({name:"Binding (Segment)",range:()=>[4,this.particleNum.n],storages:[{buffer:this.storageBuffer_particle}],sharedUniforms:[{buffer:this.uniformBuffer_frame},{buffer:this.uniformBuffer_static},{buffer:this.map.dynamicUniformBuffer}]}),this.segmentPipeline=j({name:"Render Pipeline (Segment)",shader:{module:W.load("Shader (Segment)","/shaders/segment.wgsl")},colorTargetStates:[{blend:ye}],primitive:{topology:"triangle-strip"}}),this.swapPasses=[D({name:"Render Pass (Past Trajectory 1)",colorAttachments:[{colorResource:this.layerTexture1}],depthStencilAttachment:{depthStencilResource:this.map.depthTexture}}).add(this.trajectoryPipeline,this.trajectoryBindings[0]),D({name:"Render Pass (Current Segment 1)",colorAttachments:[{colorResource:this.layerTexture1,loadOp:"load"}],depthStencilAttachment:{depthStencilResource:this.map.depthTexture,depthLoadOp:"load"}}).add(this.segmentPipeline,this.segmentBinding),D({name:"Render Pass (Past Trajectory 2)",colorAttachments:[{colorResource:this.layerTexture2}],depthStencilAttachment:{depthStencilResource:this.map.depthTexture}}).add(this.trajectoryPipeline,this.trajectoryBindings[1]),D({name:"Render Pass (Current Segment 2)",colorAttachments:[{colorResource:this.layerTexture2,loadOp:"load"}],depthStencilAttachment:{depthStencilResource:this.map.depthTexture,depthLoadOp:"load"}}).add(this.segmentPipeline,this.segmentBinding),D({name:"Render Pass (Texture Empty)",colorAttachments:[{colorResource:this.layerTexture1},{colorResource:this.layerTexture2}]})],this.layerBindings=[F({name:"Binding (Layer Renderig 1)",range:()=>[4],textures:[{texture:this.layerTexture1}]}),F({name:"Binding (Layer Renderig 2)",range:()=>[4],textures:[{texture:this.layerTexture2}]})],this.layerPipeline=j({name:"Render Pipeline (Layer Rendering)",shader:{module:W.load("Shader (Flow Layer Rendering)","/shaders/flowLayer.wgsl")},primitive:{topology:"triangle-strip"},colorTargetStates:[{blend:Q}]}),this.showBinding=F({name:"Binding (Flow Show)",range:()=>[4],textures:[{texture:this.flowTexture,sampleType:"unfilterable-float"}],sharedUniforms:[{buffer:this.uniformBuffer_frame}]}),this.showPipeline=j({name:"Render Pipeline (Flow Show)",shader:{module:W.load("Shader (Flow Show)","/shaders/flowShow.wgsl")},primitive:{topology:"triangle-strip"},colorTargetStates:[{blend:Q}]}),this.arrowBinding=F({name:"Binding (Arrow)",range:()=>[4,this.particleNum.n],storages:[{buffer:this.storageBuffer_particle}],sharedUniforms:[{buffer:this.uniformBuffer_frame},{buffer:this.uniformBuffer_static},{buffer:this.map.dynamicUniformBuffer}]}),this.arrowPipeline=j({name:"Render Pipeline (Flow Arrow)",shader:{module:W.load("Shader (Flow Show)","/shaders/arrow.wgsl")},primitive:{topology:"triangle-strip"},colorTargetStates:[{blend:Q}]}),this.swapPasses[0].executable=!0,this.swapPasses[1].executable=!0,this.swapPasses[2].executable=!1,this.swapPasses[3].executable=!1,this.swapPasses[4].executable=!1,this.layerBindings[0].executable=!0,this.layerBindings[1].executable=!1,this.showArrow&&this.map.add2RenderPass(this.arrowPipeline,this.arrowBinding),this.showVoronoi&&this.map.add2RenderPass(this.showPipeline,this.showBinding).add2RenderPass(this.layerPipeline,this.layerBindings[0]).add2RenderPass(this.layerPipeline,this.layerBindings[1]),this.map.add2PreProcess(this.voronoiPass).add2PreProcess(this.simulationPass).add2PreProcess(this.swapPasses[0]).add2PreProcess(this.swapPasses[1]).add2PreProcess(this.swapPasses[2]).add2PreProcess(this.swapPasses[3]).add2PreProcess(this.swapPasses[4]),this.isInitialized=!0}idle(){this.trajectoryPipeline&&(this.trajectoryPipeline.executable=!1)}restart(){this.trajectoryPipeline&&(this.trajectoryPipeline.executable=!0)}show(){this.isHided=!1}hide(){this.isHided=!0}makeVisibility(s){s?(this.showPipeline.executable=!0,this.voronoiPass.executable=!0,this.simulationPass.executable=!0):(this.showPipeline.executable=!1,this.layerBindings[0].executable=!1,this.layerBindings[1].executable=!1,this.voronoiPass.executable=!1,this.swapPasses[0].executable=!1,this.swapPasses[1].executable=!1,this.swapPasses[2].executable=!1,this.simulationPass.executable=!1)}updateMaxSpeed(s){this.maxSpeed.n=s>this.maxSpeed.n?s:this.maxSpeed.n}updateVoronoi(){this.nextPreparing||(this.progress===0&&(this.currentResourcePointer=(this.currentResourcePointer+1)%this.uvUrlList.length,this.addVoronoiBindingAsync(this.uvUrlList[this.currentResourcePointer])),this.progress=Math.min(this.progress+1,this.framesPerPhase-1),this.nextPrepared&&this.progress===this.framesPerPhase-1&&(this.progress=0,this.swapVoronoiBinding()),this.progressRate.n=this.progress/(this.framesPerPhase-1))}swapVoronoiBinding(){let s=this.fromRef.value;this.fromRef.value=this.toRef.value,this.toRef.value=s,s=this.toRef.value,this.toRef.value=this.nextRef.value,this.nextRef.value=s,this.nextPrepared=!1}addWorker(s){const o=this;this.worker=s,this.worker.addEventListener("message",m=>{const{url:g,maxSpeed:v,uvs:r}=m.data;o.updateMaxSpeed(v),o.nextRef.value=r,o.nextPrepared=!0,o.nextPreparing=!1})}addVoronoiBindingAsync(s){this.nextPreparing=!0,this.worker.postMessage({url:s})}get localProgress(){return this.progressRate.n}get globalProgress(){return(this.currentResourcePointer+this.progressRate.n)/this.uvUrlList.length}destroy(){this.type=void 0,this.map=void 0,this.id=void 0,this.renderingMode=void 0,this.preheat=void 0,this.swapPointer=void 0,this.extent=void 0,this.worker=void 0,this.uvUrlList=void 0,this.stationUrl=void 0,this.endPoint=void 0,this.progress=void 0,this.startPoint=void 0,this.framesPerPhase=void 0,this.maxSpeed=void 0,this.maxParticleNum=void 0,this.progressRate=void 0,this.currentResourcePointer=void 0,this.particleNum=void 0,this.speedFactor=void 0,this.timePointParser=void 0,this.randomSeed=void 0,this.blockSizeX=void 0,this.blockSizeY=void 0,this.lastMvp=void 0,this.lastMvpInverse=void 0,this.groupSizeX=void 0,this.groupSizeY=void 0,this.randomFillData=void 0,this.toRef=void 0,this.fromRef=void 0,this.nextRef=void 0,this.uniformBuffer_frame=void 0,this.indexBuffer_voronoi=void 0,this.vertexBuffer_voronoi=void 0,this.uniformBuffer_static=void 0,this.storageBuffer_particle=void 0,this.particleRef=void 0,this.flowTexture=void 0,this.depthTexture=void 0,this.layerTexture1=void 0,this.layerTexture2=void 0,this.copiedDepthTexture=void 0,this.showBinding=void 0,this.layerBindings=void 0,this.voronoiBinding=void 0,this.segmentBinding=void 0,this.voronoiToBinding=void 0,this.simulationBinding=void 0,this.trajectoryBindings=void 0,this.showPipeline=void 0,this.layerPipeline=void 0,this.voronoiPipeline=void 0,this.segmentPipeline=void 0,this.trajectoryPipeline=void 0,this.simulationPipeline=void 0,this.swapPasses=void 0,this.voronoiPass=void 0,this.simulationPass=void 0,this.isHided=void 0,this.isIdling=void 0,this.showArrow=void 0,this.showVoronoi=void 0,this.nextPrepared=void 0,this.isInitialized=void 0,this.nextPreparing=void 0}}function Re(R){const s=new Float32Array(2);s[0]=R;const o=R-s[0];return s[1]=o,s}const St=Le({__name:"StormGraph",props:{modelValue:{type:Boolean},modelModifiers:{}},emits:["update:modelValue"],setup(R){const s=Ce(R,"modelValue");let o=null;const m=c(),g=Te(),v=ue(()=>mt(g.currentStationID)),r=c(null),n=ue(()=>r.value===null||r.value.hpre.length!==0);return ee(g,async()=>{r.value=await we(g.currentStationID),console.log(s.value),o&&(o.clear(),Pe(o,r.value,v.value,n.value,s.value||!1))}),ke(async()=>{r.value=await we(g.currentStationID),n.value&&(o=gt(m),Pe(o,r.value,v.value,n.value,s.value||!1))}),(a,d)=>(te(),se("div",{ref_key:"echartsRef",ref:m,class:"h-full w-full bg-white"},null,512))}}),U=R=>(Oe("data-v-421e14f6"),R=R(),Ge(),R),_t={class:"flex h-full"},Bt={class:"flex h-full flex-auto relative justify-center"},Rt={class:"absolute z-10 top-3 py-1 px-16 text-yellow-400 font-bold text-2xl flex justify-center bg-slate-700/50 rounded"},Lt={class:"card"},Tt=U(()=>t("div",{class:"imge"},[t("div",{class:"title"},"图层控制")],-1)),kt={class:"Description"},Vt={class:"radio-buttons"},Ft=["value"],Ut=["onClick"],It=["onClick"],Mt=U(()=>t("canvas",{id:"GPUFrame",class:"playground"},null,-1)),At={class:"bg-white w-[22rem] flex flex-col"},zt={class:"h-24 m-2 border border-zinc-300 bg-white"},Wt=U(()=>t("div",{class:"h-10 leading-10 px-3 bg-[#1b6ec8] text-white"}," 历史风暴潮 ",-1)),Dt={class:"h-54 m-2 border border-zinc-300 bg-white"},Nt=U(()=>t("div",{class:"h-10 leading-10 px-3 bg-[#1b6ec8] text-white"},"历史信息",-1)),jt={class:"mx-2 my-2 flex flex-col"},Ct=U(()=>t("span",{class:"inline-block pr-2 text-lg"},"当前时间:",-1)),Et={class:"inline-block pr-3"},$t={class:"mx-2 my-2 flex flex-col"},qt=U(()=>t("span",{class:"inline-block pr-2 text-lg"},"中心位置:",-1)),Ht={class:"inline-block pr-3"},Xt={class:"inline-block pr-3"},Yt={class:"mx-2 my-2 flex flex-col"},Ot=U(()=>t("span",{class:"inline-block pr-2 text-lg"},"当前强度:",-1)),Gt={class:"inline-block pr-3"},Jt={class:"mx-2 my-2 flex flex-col"},Kt=U(()=>t("span",{class:"inline-block pr-2 text-lg"},"当前风速:",-1)),Qt={class:"inline-block pr-3"},Zt={class:"m-2 mt-2 w-[21rem] bg-white"},es=U(()=>t("div",{class:"h-10 leading-10 px-3 bg-[#1b6ec8] text-white"},"历史路径",-1)),ts={class:"border border-zinc-300"},ss=Le({__name:"StormMapView",setup(R){const s=c(!1),o=c(0),m=c(0),g=Te(),v=c(null),r=c(null),n=c("0"),a=c(null),d=c(null),P=c(null),b=c("199711"),i=Ze(),ie=c(0),ae=c(0),re=c([0,0]),Ve=[{label:"风场",value:0},{label:"流场",value:1},{label:"增水场",value:2}],y=c(null),G=c(null),Fe=e=>{n.value=e.id},Ue=async()=>{n.value="0",d.value=await be(b.value),P.value=Se(d.value),a.value=d.value.dataList[Number(n.value)],wt(i.map,b.value),_e(i.map,[a.value.lng,a.value.lat]),i.map.flyTo({center:[a.value.lng,a.value.lat]})};let _=0;const J=c(0);let M=null;const ne=async(e,u)=>{const l="/ffvsrc/9711add/contour_",x="/ffvsrc/9711add/addWater_";if(u){const w=e,I=["pngsource","contourSrc"];["addWater","contourLayer","contourLabel"].forEach(p=>{i.map.getLayer(p)&&i.map.removeLayer(p)}),I.forEach(p=>{i.map.getSource(p)&&i.map.removeSource(p)}),G.value=await tt(i.map,w,l,x),st(i.map)}else{const w=e,I=["pngsource2","contourSrc2"];["addWater2","contourLayer2","contourLabel2"].forEach(p=>{i.map.getLayer(p)&&i.map.removeLayer(p)}),I.forEach(p=>{i.map.getSource(p)&&i.map.removeSource(p)}),G.value=await it(i.map,w,l,x),at(i.map)}const S=w=>{let I=w.features,L=-999,p=999;return I.forEach(T=>{T.properties.addWater&&T.properties.addWater>L?L=T.properties.addWater:T.properties.addWater&&T.properties.addWater<p&&(p=T.properties.addWater)}),console.log(L,p),[L,p]};re.value=S(G.value),A.value=e};let oe=new Array(22);for(let e=0;e<22;e++)oe[e]=`/ffvsrc/9711wind/uv_${16+e}.bin`;let le=new Array(22);for(let e=0;e<22;e++)e*6<132&&(le[e]=`/ffvsrc/9711flow/uv_${e*6}.bin`);let f=he(new ct("flow","/ffvsrc/9711flow/station.bin",le,e=>e.match(/uv_(\d+)\.bin/)[1],"/ffvsrc/flowbound2.geojson"));f.framesPerPhase=150,f.speedFactor.n=2.5;let h=he(new bt("wind","/ffvsrc/9711wind/station.bin",oe,e=>e.match(/uv_(\d+)\.bin/)[1]));h.framesPerPhase=150,h.speedFactor.n=1,ee(y,async(e,u)=>{if(!i.map){C({message:"地图尚未加载完毕，请等待..",type:"warning"});return}switch(u){case 0:h.hide();break;case 1:f.hide();break;case 2:clearInterval(M),M=null;const x=["pngsource","contourSrc","pngsource2","contourSrc2"];["addWater","contourLayer","contourLabel","addWater2","contourLayer2","contourLabel2"].forEach(w=>{i.map.getLayer(w)&&i.map.removeLayer(w)}),x.forEach(w=>{i.map.getSource(w)&&i.map.removeSource(w)});break}let l=Math.floor(A.value/h.uvUrlList.length*100);switch(l<3?l=l-3+100:l=l-3,e){case 0:C({offset:50,message:"正在加载风场..."}),h.setProgress(l),h.show(),i.map.flyTo({center:[121.45,32.68],zoom:5.08,duration:500});break;case 1:C({offset:50,message:"正在加载流场..."}),f.setProgress(l),f.show(),i.map.flyTo({center:[121.5,31.56],zoom:7,duration:500});break;case 2:C({offset:50,message:"正在加载增水场..."}),i.map.flyTo({center:[121.5,31.56],zoom:7,duration:500}),_=A.value,J.value=A.value,M||(M=setInterval(()=>{ne(_,_%2),_=(_+1)%22,J.value=_},3e3)),ne(_,_%2),_=(_+1)%22,J.value=_;break}});const de=()=>{h.hide(),f.hide(),M&&(clearInterval(M),M=null);const e=["pngsource","contourSrc","pngsource2","contourSrc2"];["addWater","contourLayer","contourLabel","addWater2","contourLayer2","contourLabel2"].forEach(l=>{i.map.getLayer(l)&&i.map.removeLayer(l)}),e.forEach(l=>{i.map.getSource(l)&&i.map.removeSource(l)}),y.value=null,r.value.forEach(l=>{l.checked=!1})};ee(n,()=>{a.value=d.value.dataList[Number(n.value)],i.map&&(i.map.flyTo({center:[a.value.lng,a.value.lat]}),_e(i.map,[a.value.lng,a.value.lat]))}),ke(async()=>{d.value=await be(b.value),P.value=Se(d.value),a.value=d.value.dataList[Number(n.value)];const e=await et(v.value,[131,30],3);C({message:"地图加载完毕",type:"success"}),e.addLayer(h),h.hide(),e.addLayer(f),f.hide(),vt(e),await yt(e,b.value),await xt(e,[a.value.lng,a.value.lat]),e.on("click",u=>{const l=[[u.point.x-3,u.point.y-3],[u.point.x+3,u.point.y+3]];if(e.getLayer("storm-point")){const x=e.queryRenderedFeatures(l,{layers:["storm-point"]});if(x&&x[0]){const S=x[0].properties.id;n.value=S}}if(e.getLayer("stations")){const x=e.queryRenderedFeatures(l,{layers:["stations"]});if(x&&x[0]){const S=x[0].properties.id;g.currentStationID=S,Ee.push("/typical-storm-surge/data")}}}),e.on("mousemove","stations",u=>{const l=[[u.point.x-3,u.point.y-3],[u.point.x+3,u.point.y+3]];if(e.getLayer("stations")){const x=e.queryRenderedFeatures(l,{layers:["stations"]});if(x&&x[0]){const S=x[0].properties.id;g.currentStationID=S,s.value=!0,o.value=u.point.x,m.value=u.point.y}}}),e.on("mouseleave","stations",()=>{s.value=!1})});const Ie=()=>{i.map&&(i.map.removeLayer("flow"),i.map.removeLayer("wind")),f.destroy(),h.destroy(),f=null,h=null,console.log("destroy")};$e(()=>{Ie(),i.map.remove()}),qe(()=>{de()});const E=c(0),$=c(0),A=c(0);He(async()=>{let e=f.currentResourcePointer/f.uvUrlList.length;E.value=Math.floor(e*100),ie.value=f.maxSpeed.n,ae.value=h.maxSpeed.n;let u=h.currentResourcePointer/h.uvUrlList.length;$.value=Math.floor(u*100),y.value===0?A.value=h.currentResourcePointer:y.value===1&&(A.value=f.currentResourcePointer)});const Me=e=>{E.value=e,f.setProgress(E.value)},Ae=e=>{f.particleNum.n=e},ze=e=>{f.speedFactor.n=e},We=e=>{$.value=e,h.setProgress($.value)},De=e=>{h.particleNum.n=e},Ne=e=>{h.speedFactor.n=e};return(e,u)=>{var I,L,p,T;const l=X("el-option"),x=X("el-select"),S=X("el-table-column"),w=X("el-table");return te(),se(ce,null,[t("div",_t,[t("div",Bt,[t("div",Rt,z((I=d.value)==null?void 0:I.name),1),t("div",Lt,[Tt,t("div",kt,[t("div",Vt,[(te(),se(ce,null,Xe(Ve,k=>t("label",{key:k.value,class:"radio-button"},[t("input",{ref_for:!0,ref_key:"radio",ref:r,type:"radio",name:"option",value:k.value},null,8,Ft),t("div",{class:"radio-circle",onClick:je=>y.value=k.value},null,8,Ut),t("span",{class:"radio-label",onClick:je=>y.value=k.value},z(k.label),9,It)])),64))])]),t("div",{class:"imge2"},[t("div",{class:"close",onClick:de},"关闭所有")])]),q(B(ft,{"max-speed":y.value==1?ie.value:y.value==0?ae.value:10,"add-range":re.value,desc:y.value==1?"流速(m/s)":y.value==0?"风速(m/s)":"风暴增水(m)"},null,8,["max-speed","add-range","desc"]),[[H,y.value==1||y.value==0||y.value==2]]),q(B(pt,{type:"9711","time-step":A.value},null,8,["time-step"]),[[H,y.value==1||y.value==0||y.value==2]]),q(B(xe,{"flow-progress":E.value,"max-particle-num":V(f).maxParticleNum,"now-particle-num":V(f).particleNum.n,"now-speed":V(f).speedFactor.n,"max-speed":10,onParticleNumValue:Ae,onProgressValue:Me,onSpeedValue:ze},null,8,["flow-progress","max-particle-num","now-particle-num","now-speed"]),[[H,y.value==1]]),q(B(xe,{"flow-progress":$.value,"max-particle-num":V(h).maxParticleNum,"now-particle-num":V(h).particleNum.n,"now-speed":V(h).speedFactor.n,"max-speed":10,onParticleNumValue:De,onProgressValue:We,onSpeedValue:Ne},null,8,["flow-progress","max-particle-num","now-particle-num","now-speed"]),[[H,y.value==0]]),t("div",{ref_key:"mapContainerRef",ref:v,class:"map-container h-full w-full"},null,512),Mt]),t("div",At,[t("div",zt,[Wt,B(x,{modelValue:b.value,"onUpdate:modelValue":u[0]||(u[0]=k=>b.value=k),class:"m-2 w-[90%]",placeholder:"Select",size:"large",onChange:Ue},{default:fe(()=>[B(l,{key:"199711",label:"温妮 (199711)",value:"199711"})]),_:1},8,["modelValue"])]),t("div",Dt,[Nt,t("div",jt,[t("div",null,[Ct,t("span",Et,z(a.value&&V(Pt)(a.value.time)),1)])]),t("div",$t,[t("div",null,[qt,t("span",Ht,z(a.value&&V(Be)(a.value.lng)),1),t("span",Xt,z(a.value&&V(Be)(a.value.lat)),1)])]),t("div",Yt,[t("div",null,[Ot,t("span",Gt,z(a.value&&`${(L=a.value)==null?void 0:L.power}级 (${(p=a.value)==null?void 0:p.strong})`),1)])]),t("div",Jt,[t("div",null,[Kt,t("span",Qt,z(a.value&&((T=a.value)==null?void 0:T.speed)+"m/s"),1)])])]),t("div",Zt,[es,t("div",ts,[B(w,{stripe:"",border:"","table-layout":"auto",data:P.value,class:"h-[57vh]",onCurrentChange:Fe},{default:fe(()=>[B(S,{prop:"time",label:"时间"}),B(S,{prop:"powerAndStrong",label:"强度"}),B(S,{prop:"speed",label:"风速"})]),_:1},8,["data"])])])])]),t("div",{class:"absolute w-[500px] h-[400px] bg-white bg-opacity-70 p-2 rounded border border-black",style:Ye({zIndex:s.value?"10":"-10",top:`${m.value-450}px`,left:`${o.value-350}px`})},[B(St,{modelValue:s.value,"onUpdate:modelValue":u[1]||(u[1]=k=>s.value=k),class:"bg-blue-300 bg-opacity-30 backdrop-blur"},null,8,["modelValue"])],4)],64)}}}),us=Je(ss,[["__scopeId","data-v-421e14f6"]]);export{us as default};
