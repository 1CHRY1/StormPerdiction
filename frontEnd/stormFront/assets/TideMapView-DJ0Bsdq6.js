import{g as te,z as ye,r as l,v as re,c as U,h as se,o as ne,b as z,d as j,a as Q,w as X,E as I,x as we,A as ge,B as he,e as u,t as B,F as Y,n as _e,j as k,C as P,f as V,y as Se,u as L,q as be,s as Le,_ as xe}from"./index-DQkqiHjE.js";import{u as We,i as Ie}from"./initMap-D0w7y-qV.js";import{p as ke,a as Pe,b as Ve,c as Re}from"./wind_back-nIZueuSL.js";import{S as Z,f as Ee,t as De,c as ee}from"./controller-BwQYg1hs.js";import{g as Fe,a as ae,i as Me,d as oe,b as Ne}from"./api-Cv14iVOH.js";import"./axios-Euv33k_P.js";import"./stationInfo-DixEZJLI.js";import"./getStation-DC6WyyE7.js";const Ae=te({__name:"TideGraph",props:{modelValue:{type:Boolean},modelModifiers:{}},emits:["update:modelValue"],setup(g){const d=ye(g,"modelValue");let v=null;const h=l(),y=re(),_=U(()=>Fe(y.currentStationID)),a=l(null),w=U(()=>a.value===null||a.value.hpre.length!==0);return se(y,async()=>{a.value=await ae(y.currentStationID),console.log(d.value),v&&(v.clear(),oe(v,a.value,_.value,w.value,d.value||!1))}),ne(async()=>{a.value=await ae(y.currentStationID),w.value&&(v=Me(h),oe(v,a.value,_.value,w.value,d.value||!1))}),(M,q)=>(z(),j("div",{ref_key:"echartsRef",ref:h,class:"h-full w-full bg-white"},null,512))}}),le=g=>(be("data-v-54b6f940"),g=g(),Le(),g),Ce=le(()=>u("canvas",{id:"GPUFrame",class:"playground"},null,-1)),Te={class:"card"},$e=le(()=>u("div",{class:"imge"},[u("div",{class:"title"},"图层控制")],-1)),Be={class:"Description"},Ue={class:"typh"},ze={class:"radio-buttons"},je=["value"],qe=["onClick"],Ge=["onClick"],He={class:"radio-button"},Oe=["value"],Je=te({__name:"TideMapView",setup(g){const d=l(!1),v=l(0),h=l(0),y=l(null),_=l(null),a=We(),w=re(),M=l(null),q=[{label:"风场",value:0},{label:"流场",value:1}],R={label:"增水场",value:2},n=l(null),N=l(null);let p=0;const E=l(0),G=async(e,o)=>{const t="/ffvsrc/9711add/contour_",c="/ffvsrc/9711add/addWater_";if(o){const m=e,x=["pngsource","contourSrc"];["addWater","contourLayer","contourLabel"].forEach(i=>{a.map.getLayer(i)&&a.map.removeLayer(i)}),x.forEach(i=>{a.map.getSource(i)&&a.map.removeSource(i)}),N.value=await ke(a.map,m,t,c),Pe(a.map)}else{const m=e,x=["pngsource2","contourSrc2"];["addWater2","contourLayer2","contourLabel2"].forEach(i=>{a.map.getLayer(i)&&a.map.removeLayer(i)}),x.forEach(i=>{a.map.getSource(i)&&a.map.removeSource(i)}),N.value=await Ve(a.map,m,t,c),Re(a.map)}const f=m=>{let x=m.features,W=-999,i=999;return x.forEach(b=>{b.properties.addWater&&b.properties.addWater>W?W=b.properties.addWater:b.properties.addWater&&b.properties.addWater<i&&(i=b.properties.addWater)}),[W,i]};J.value=f(N.value)};let H=new Array(144);for(let e=0;e<144;e++)H[e]=`/field/wind/bin?name=uv_${e}.bin`;let O=new Array(144);for(let e=0;e<144;e++)O[e]=`/field/flow/bin?name=uv_${e}.bin`;let r=Q(new Z("wind","/field/wind/bin?name=station.bin",H,e=>e.match(/uv_(\d+)\.bin/)[1],"/ffvsrc/windBound.geojson")),s=Q(new Z("flow","/field/flow/bin?name=station.bin",O,e=>e.match(/uv_(\d+)\.bin/)[1],"/ffvsrc/flowbound2.geojson"));s.speedFactor.n=3;const A=l(0),C=l(0),J=l([0,0]),T=l(0);X(()=>{A.value=s.maxSpeed.n,C.value=r.maxSpeed.n}),se(n,async(e,o)=>{if(!a.map){I({message:"地图尚未加载完毕，请等待..",type:"warning"});return}switch(o){case 0:r.hide(),S.value=r.currentResourcePointer;break;case 1:s.hide(),S.value=s.currentResourcePointer;break;case 2:clearInterval(E.value);const c=["pngsource","contourSrc","pngsource2","contourSrc2"];["addWater","contourLayer","contourLabel","addWater2","contourLayer2","contourLabel2"].forEach(m=>{a.map.getLayer(m)&&a.map.removeLayer(m)}),c.forEach(m=>{a.map.getSource(m)&&a.map.removeSource(m)});break}let t=Math.floor(S.value/r.uvUrlList.length*100);switch(t<1?t=t-1+100:t=t-1,e){case 0:I({offset:50,message:"正在加载风场..."}),r.setProgress(t),r.show(),a.map.flyTo({center:[121.45,32.68],zoom:5.08,duration:500});break;case 1:I({offset:50,message:"正在加载流场..."}),s.setProgress(t),s.show(),a.map.flyTo({center:[121.5,31.56],zoom:7,duration:500});break;case 2:I({offset:50,message:"正在加载增水场..."}),a.map.flyTo({center:[121.5,31.56],zoom:7,duration:500}),p=4,T.value=4,E.value=setInterval(()=>{G(p,p%2),p=(p+1)%80,T.value=p},3e3),setTimeout(()=>{G(p,p%2),p=(p+1)%80,T.value=p},0);break}});const K=()=>{r.hide(),s.hide(),E.value&&clearInterval(E.value);const e=["pngsource","contourSrc","pngsource2","contourSrc2"];["addWater","contourLayer","contourLabel","addWater2","contourLayer2","contourLabel2"].forEach(t=>{a.map.getLayer(t)&&a.map.removeLayer(t)}),e.forEach(t=>{a.map.getSource(t)&&a.map.removeSource(t)}),n.value=null,_.value&&(_.value.checked=!1),y.value.forEach(t=>{t.checked=!1})},$=l(0),ue=U(()=>$.value==1?"当前有台风 !":"当前无台风 !");ne(async()=>{$.value=0;const e=await Ie(M.value,[120.55,32.08],6.5);I({message:"地图加载完毕",type:"success"}),e.addLayer(r),r.hide(),e.addLayer(s),s.hide(),window.addEventListener("keydown",o=>{o.key==="\\"&&console.log(e)}),Ne(e),e.on("click",o=>{const t=[[o.point.x-3,o.point.y-3],[o.point.x+3,o.point.y+3]];if(e.getLayer("stations")){const c=e.queryRenderedFeatures(t,{layers:["stations"]});if(c&&c[0]){const f=c[0].properties.id;w.currentStationID=f,we.push("/tide-forecast/data")}}}),e.on("mousemove","stations",o=>{const t=[[o.point.x-3,o.point.y-3],[o.point.x+3,o.point.y+3]];if(e.getLayer("stations")){const c=e.queryRenderedFeatures(t,{layers:["stations"]});if(c&&c[0]){const f=c[0].properties.id;w.currentStationID=f,d.value=!0,v.value=o.point.x,h.value=o.point.y}}}),e.on("mouseleave","stations",()=>{d.value=!1}),e.on("mousemove","stations",o=>{const t=[[o.point.x-3,o.point.y-3],[o.point.x+3,o.point.y+3]];if(e.getLayer("stations")){const c=e.queryRenderedFeatures(t,{layers:["stations"]});if(c&&c[0]){const f=c[0].properties.id;w.currentStationID=f,d.value=!0,v.value=o.point.x,h.value=o.point.y}}}),e.on("mouseleave","stations",()=>{d.value=!1})});const ce=()=>{a.map&&(a.map.removeLayer("flow"),a.map.removeLayer("wind")),s.destroy(),r.destroy(),s=null,r=null,console.log("destroy")};ge(()=>{ce(),a.map.remove()}),he(()=>{K()});const D=l(0),F=l(0),S=l(0);X(()=>{let e=s.currentResourcePointer/s.uvUrlList.length;D.value=Math.floor(e*100),A.value=s.maxSpeed.n,C.value=r.maxSpeed.n;let o=r.currentResourcePointer/r.uvUrlList.length;F.value=Math.floor(o*100),n.value===0?S.value=r.currentResourcePointer:n.value===1&&(S.value=s.currentResourcePointer)});const ie=e=>{D.value=e,s.setProgress(D.value)},de=e=>{s.particleNum.n=e},pe=e=>{s.speedFactor.n=e},me=e=>{F.value=e,r.setProgress(F.value)},ve=e=>{r.particleNum.n=e},fe=e=>{r.speedFactor.n=e};return(e,o)=>(z(),j(Y,null,[u("div",{ref_key:"mapContainerRef",ref:M,class:"map-container h-full w-full"},null,512),Ce,u("div",Te,[$e,u("div",Be,[u("div",Ue,B(ue.value),1),u("div",ze,[(z(),j(Y,null,_e(q,t=>u("label",{key:t.value,class:"radio-button"},[u("input",{ref_for:!0,ref_key:"radio",ref:y,type:"radio",name:"option",value:t.value},null,8,je),u("div",{class:"radio-circle",onClick:c=>n.value=t.value},null,8,qe),u("span",{class:"radio-label",onClick:c=>n.value=t.value},B(t.label),9,Ge)])),64)),k(u("label",He,[u("input",{ref_key:"radio2",ref:_,type:"radio",name:"option",value:R.value},null,8,Oe),u("div",{class:"radio-circle",onClick:o[0]||(o[0]=t=>n.value=R.value)}),u("span",{class:"radio-label",onClick:o[1]||(o[1]=t=>n.value=R.value)},B(R.label),1)],512),[[P,$.value]])])]),u("div",{class:"imge2"},[u("div",{class:"close",onClick:K},"关闭所有 ")])]),k(V(Ee,{"max-speed":n.value==1?A.value:n.value==0?C.value:10,"add-range":J.value,desc:n.value==1?"流速(m/s)":n.value==0?"风速(m/s)":"风暴增水(m)"},null,8,["max-speed","add-range","desc"]),[[P,n.value==1||n.value==0||n.value==2]]),u("div",{class:"absolute w-[500px] h-[400px] bg-white bg-opacity-70 p-2 rounded border border-black",style:Se({zIndex:d.value?"10":"-10",top:`${h.value-450}px`,left:`${v.value-350}px`})},[V(Ae,{modelValue:d.value,"onUpdate:modelValue":o[2]||(o[2]=t=>d.value=t),class:"bg-blue-300 bg-opacity-30 backdrop-blur"},null,8,["modelValue"])],4),k(V(De,{type:"normal","time-step":S.value},null,8,["time-step"]),[[P,n.value==1||n.value==0||n.value==2]]),k(V(ee,{"flow-progress":D.value,"max-particle-num":L(s).maxParticleNum,"now-particle-num":L(s).particleNum.n,"now-speed":L(s).speedFactor.n,"max-speed":10,onParticleNumValue:de,onProgressValue:ie,onSpeedValue:pe},null,8,["flow-progress","max-particle-num","now-particle-num","now-speed"]),[[P,n.value==1]]),k(V(ee,{"flow-progress":F.value,"max-particle-num":L(r).maxParticleNum,"now-particle-num":L(r).particleNum.n,"now-speed":L(r).speedFactor.n,"max-speed":10,onParticleNumValue:ve,onProgressValue:me,onSpeedValue:fe},null,8,["flow-progress","max-particle-num","now-particle-num","now-speed"]),[[P,n.value==0]])],64))}}),ta=xe(Je,[["__scopeId","data-v-54b6f940"]]);export{ta as default};
