import cv2 as cv
from datetime import datetime

mat_0 = [[255, 0, 0, 0, 255],
         [0, 255, 255, 255, 0],
         [0, 255, 255, 255, 0],
         [0, 255, 255, 255, 0],
         [0, 255, 255, 255, 0],
         [0, 255, 255, 255, 0],
         [0, 255, 255, 255, 0],
         [0, 255, 255, 255, 0],
         [255, 0, 0, 0, 255]]

mat_1 = [[255, 255, 255, 0, 255],
         [255, 255, 0, 0, 255],
         [255, 0, 255, 0, 255],
         [255, 255, 255, 0, 255],
         [255, 255, 255, 0, 255],
         [255, 255, 255, 0, 255],
         [255, 255, 255, 0, 255],
         [255, 255, 255, 0, 255],
         [255, 255, 255, 0, 255]]

mat_2 = [[255, 0, 0, 0, 255],
         [0, 255, 255, 255, 0],
         [255, 255, 255, 255, 0],
         [255, 255, 255, 255, 0],
         [255, 255, 255, 0, 255],
         [255, 255, 255, 0, 255],
         [255, 255, 0, 255, 255],
         [255, 0, 255, 255, 255],
         [0, 0, 0, 0, 0]]

mat_3 = [[255, 0, 0, 0, 255],
         [0, 255, 255, 255, 0],
         [255, 255, 255, 255, 0],
         [255, 255, 255, 255, 0],
         [255, 255, 0, 0, 255],
         [255, 255, 255, 255, 0],
         [255, 255, 255, 255, 0],
         [0, 255, 255, 255, 0],
         [255, 0, 0, 0, 255]]

mat_4 = [[255, 255, 255, 0, 255],
         [255, 255, 0, 0, 255],
         [255, 255, 0, 0, 255],
         [255, 0, 255, 0, 255],
         [255, 0, 255, 0, 255],
         [0, 255, 255, 0, 255],
         [0, 0, 0, 0, 0],
         [255, 255, 255, 0, 255],
         [255, 255, 255, 0, 255]]

mat_5 = [[255, 0, 0, 0, 0],
         [255, 0, 255, 255, 255],
         [0, 255, 255, 255, 255],
         [0, 0, 0, 0, 255],
         [0, 255, 255, 255, 0],
         [255, 255, 255, 255, 0],
         [255, 255, 255, 255, 0],
         [0, 255, 255, 255, 0],
         [255, 0, 0, 0, 255]]

mat_6 = [[255, 0, 0, 0, 255],
         [0, 255, 255, 255, 0],
         [0, 255, 255, 255, 255],
         [0, 255, 0, 0, 255],
         [0, 0, 255, 255, 0],
         [0, 255, 255, 255, 0],
         [0, 255, 255, 255, 0],
         [0, 255, 255, 255, 0],
         [255, 0, 0, 0, 255]]

mat_7 = [[0, 0, 0, 0, 0],
         [255, 255, 255, 255, 0],
         [255, 255, 255, 0, 255],
         [255, 255, 0, 255, 255],
         [255, 255, 0, 255, 255],
         [255, 255, 0, 255, 255],
         [255, 0, 255, 255, 255],
         [255, 0, 255, 255, 255],
         [255, 0, 255, 255, 255]]

mat_8 = [[255, 0, 0, 0, 255],
         [0, 255, 255, 255, 0],
         [0, 255, 255, 255, 0],
         [0, 255, 255, 255, 0],
         [255, 0, 0, 0, 255],
         [0, 255, 255, 255, 0],
         [0, 255, 255, 255, 0],
         [0, 255, 255, 255, 0],
         [255, 0, 0, 0, 255]]

mat_9 = [[255, 0, 0, 0, 255],
         [0, 255, 255, 255, 0],
         [0, 255, 255, 255, 0],
         [0, 255, 255, 255, 0],
         [0, 255, 255, 0, 0],
         [255, 0, 0, 255, 0],
         [255, 255, 255, 255, 0],
         [0, 255, 255, 255, 0],
         [255, 0, 0, 0, 255]]

mat_dot = [[255, 255, 255, 255, 255],
           [255, 255, 255, 255, 255],
           [255, 255, 255, 255, 255],
           [255, 255, 255, 255, 255],
           [255, 255, 255, 255, 255],
           [255, 255, 255, 255, 255],
           [255, 255, 255, 255, 255],
           [255, 255, 255, 255, 255],
           [255, 255, 0, 255, 255]]

mat_colon = [[255, 255, 255, 255, 255],
             [255, 255, 255, 255, 255],
             [255, 255, 0, 255, 255],
             [255, 255, 255, 255, 255],
             [255, 255, 255, 255, 255],
             [255, 255, 255, 255, 255],
             [255, 255, 255, 255, 255],
             [255, 255, 255, 255, 255],
             [255, 255, 0, 255, 255]]

mat_ = [[255, 255, 255, 255, 255],
        [255, 255, 255, 255, 255],
        [255, 255, 255, 255, 255],
        [255, 255, 255, 255, 255],
        [255, 255, 255, 255, 255],
        [255, 0, 0, 0, 255],
        [255, 255, 255, 255, 255],
        [255, 255, 255, 255, 255],
        [255, 255, 255, 255, 255]]

mat_list = [
    {
        "mat": mat_0,
        "value": "0"
    },
    {
        "mat": mat_1,
        "value": "1"
    },
    {
        "mat": mat_2,
        "value": '2'
    },
    {
        "mat": mat_3,
        "value": '3'
    },
    {
        "mat": mat_4,
        "value": '4'
    },
    {
        "mat": mat_5,
        "value": '5'
    },
    {
        "mat": mat_6,
        "value": '6'
    },
    {
        "mat": mat_7,
        "value": '7'
    },
    {
        "mat": mat_8,
        "value": '8'
    },
    {
        "mat": mat_9,
        "value": '9'
    },
    {
        "mat": mat_dot,
        "value": '.'
    },
    {
        "mat": mat_colon,
        "value": ':'
    },
    {
        "mat": mat_,
        "value": '-'
    }

]


def check_matrix(img, row, col, mat):
    for i in range(9):
        for j in range(5):
            if img[row + i, col + j] != mat[i][j]:
                return False
    return True


def execute(path, column_list):
    img = cv.imread(path)
    img = cv.cvtColor(img, cv.COLOR_BGR2GRAY)
    thresh_img = cv.threshold(img, 240, 255, cv.THRESH_BINARY + cv.THRESH_OTSU)[1]

    result = []
    for i in range(thresh_img.shape[0] - 8):
        row_result = []
        for j in range(len(column_list)):
            temp_str = ''
            for k in range(column_list[j]['start'], column_list[j]['end'] - 3):
                for l in range(len(mat_list)):
                    if check_matrix(thresh_img, i, k, mat_list[l]['mat']):
                        temp_str += mat_list[l]['value']
            row_result.append(temp_str)
        if row_result[0] != '' and '0' <= row_result[0][0] <= '9':
            result.append(row_result)
    for res in result:
        res[0] = str(datetime.now().year) + "-" + res[0][0:5] + " " + res[0][5:10] + ":00"
    return result


